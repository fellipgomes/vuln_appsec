name: Deploy to Amazon EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    env: 
      SECRET_PATH: ${{ secrets.SECRET_PATH }}
      REMOTE_PATH: ${{ vars.REMOTE_PATH }}
      AWS_SSH_ACCESS: ${{ secrets.SSH_KEY_AWS }}
      LOCAL_PATH: ${{ vars.LOCAL_GIT_PATH }}
    
    steps:
          - name: Checkout
            uses: actions/checkout@v3
            
          - id: validation
            name: Validation acess-key from ssh
            run: |
              echo "${AWS_SSH_ACCESS}" > $SECRET_PATH
              
          - name: Check permissions
            run: |
              chmod 400 $SECRET_PATH            
              
          - name: Update code
            run: |
              rm -rf $LOCAL_PATH/.* 2> /dev/null
              scp -i $SECRET_PATH -o "StrictHostKeyChecking no" -r $LOCAL_PATH/* $REMOTE_PATH
              echo "Finish"
